// Substitua a seção de "LÓGICA DE LOGIN E AUTENTICAÇÃO" por esta versão corrigida:

// =================================================================================
// LÓGICA DE LOGIN E AUTENTICAÇÃO
// =================================================================================

// Configura o evento de login imediatamente quando o script carrega
let loginConfigured = false;

function setupLoginForm() {
    if (loginConfigured) return;
    
    const loginForm = document.getElementById('login-form');
    const loginButton = document.querySelector('#login-form button[type="submit"]');
    
    if (!loginForm) {
        // Se o formulário não existe ainda, tenta novamente em 100ms
        setTimeout(setupLoginForm, 100);
        return;
    }
    
    // Remove qualquer listener anterior para evitar duplicatas
    loginForm.removeEventListener('submit', handleLogin);
    
    // Adiciona o listener de submit
    loginForm.addEventListener('submit', handleLogin);
    
    // Adiciona listener para Enter nos campos de input
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    
    [emailInput, passwordInput].forEach(input => {
        if (input) {
            input.removeEventListener('keydown', handleLoginKeydown);
            input.addEventListener('keydown', handleLoginKeydown);
        }
    });
    
    loginConfigured = true;
}

function handleLoginKeydown(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        const form = e.target.closest('form');
        if (form) {
            handleLogin({ preventDefault: () => {}, target: form });
        }
    }
}

async function handleLogin(e) {
    e.preventDefault();
    
    const loginButton = document.querySelector('#login-form button[type="submit"]');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const errorDiv = document.getElementById('login-error');
    
    // Validação básica
    if (!emailInput || !passwordInput) {
        console.error('Campos de login não encontrados');
        return;
    }
    
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    
    if (!email || !password) {
        errorDiv.textContent = 'Por favor, preencha todos os campos.';
        errorDiv.classList.remove('hidden');
        return;
    }
    
    // Mostra loading no botão
    toggleButtonLoading(loginButton, true);
    
    // Esconde erro anterior
    errorDiv.classList.add('hidden');
    
    try {
        const { error } = await supabaseClient.auth.signInWithPassword({ 
            email, 
            password 
        });
        
        if (error) {
            throw error;
        }
        
        // Login bem-sucedido - o onAuthStateChange cuidará do redirecionamento
        
    } catch (error) {
        console.error('Erro no login:', error);
        errorDiv.textContent = error.message === 'Invalid login credentials' 
            ? 'E-mail ou senha inválidos.' 
            : `Erro ao fazer login: ${error.message}`;
        errorDiv.classList.remove('hidden');
    } finally {
        toggleButtonLoading(loginButton, false);
    }
}

// Configura o login assim que o DOM estiver pronto
document.addEventListener('DOMContentLoaded', setupLoginForm);

// Backup: configura novamente quando a janela carregar completamente
window.addEventListener('load', setupLoginForm);

supabaseClient.auth.onAuthStateChange(async (event, session) => {
    if (session && session.user) {
        const { data: profileData } = await supabaseClient
            .from('mkt_users').select('*').eq('email', session.user.email).single();
        
        if (profileData) {
            state.currentUser = profileData;
            if (document.getElementById('app-container').classList.contains('hidden')) {
                initializeApp();
            } else {
                setupUserMenu();
            }
        } else {
            console.error("Utilizador autenticado mas não foi encontrado perfil.");
            await handleLogout();
        }
    } else {
        state.currentUser = null;
        document.getElementById('app-container').classList.add('hidden');
        document.getElementById('login-screen').classList.remove('hidden');
        
        // Reconfigura o formulário de login quando voltar à tela de login
        setTimeout(setupLoginForm, 100);
    }
});

async function handleLogout() {
    const { error } = await supabaseClient.auth.signOut();
    if (error) handleSupabaseError(error, 'logout');
}
